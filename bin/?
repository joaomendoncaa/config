#!/usr/bin/env bash

query="$*"

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid >/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        printf "\b\b\b\b\b\b"
        sleep $delay
    done
    printf "\r%*s" $(tput cols) ""
    printf "\r"
}

call_claude() {
    local prompt="$1"
    local json_payload=$(jq -n \
        --arg model "claude-3-opus-20240229" \
        --arg prompt "$prompt" \
        --arg max_tokens "1000" \
        '{
            model: $model,
            max_tokens: $max_tokens | tonumber,
            messages: [
                {
                    role: "user",
                    content: $prompt
                }
            ]
        }')

    curl -s https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "$json_payload"
}

if [ -z "$query" ]; then
    echo "Please provide a query"
    exit 1
fi

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "Please set ANTHROPIC_API_KEY environment variable"
    exit 1
fi

prompt="You are a Linux command expert. Given this question: '$query', provide a list of relevant commands that would help solve it. For each command, include a very brief description of what it does. Format your response as a bullet list with each item formatted as: '- \`command\`: brief description'. Do not include any other text or explanations."

printf "Thinking"
call_claude "$prompt" >response.tmp &
spinner $!

if ! grep -q "content" response.tmp; then
    echo "Error: Invalid response format"
    cat response.tmp
    rm response.tmp
    exit 1
fi

command_list=$(grep -o '"text":"[^"]*"' response.tmp | sed 's/"text":"//;s/"$//')
rm response.tmp

if [ -z "$command_list" ]; then
    echo "Error: Empty response received"
    exit 1
fi

echo "$command_list"
