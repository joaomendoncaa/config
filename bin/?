#!/bin/sh

query="$*"
ERROR_MESSAGE_NO_CMD="couldn't find the wanted command"

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid >/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        printf "\b\b\b\b\b\b"
        sleep $delay
    done
    printf "\r%*s" $(tput cols) ""
    printf "\r"
}

call_claude() {
    local prompt="$1"
    local json_payload=$(jq -n \
        --arg model "claude-3-opus-20240229" \
        --arg prompt "$prompt" \
        --arg max_tokens "1000" \
        '{
            model: $model,
            max_tokens: $max_tokens | tonumber,
            messages: [
                {
                    role: "user",
                    content: $prompt
                }
            ]
        }')

    curl -s https://api.anthropic.com/v1/messages \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "$json_payload"
}

if [ -z "$query" ]; then
    echo "Please provide a query"
    exit 1
fi

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "Please set ANTHROPIC_API_KEY environment variable"
    exit 1
fi

prompt="You are a Linux command expert. Given this question: '$query', respond ONLY with a single Linux command that would solve it. If you can't determine an appropriate command, respond exactly with: '$ERROR_MESSAGE_NO_CMD'. Do not include any explanations or additional text."

printf "Thinking"
call_claude "$prompt" >response.tmp &
spinner $!

if ! grep -q "content" response.tmp; then
    echo "Error: Invalid response format"
    cat response.tmp
    rm response.tmp
    exit 1
fi

command_response=$(grep -o '"text":"[^"]*"' response.tmp | sed 's/"text":"//;s/"$//')
rm response.tmp

if [ -z "$command_response" ]; then
    echo "Error: Empty command response received"
    echo "Raw response: $response"
    exit 1
fi

if [ "$command_response" != "$ERROR_MESSAGE_NO_CMD" ]; then
    echo "Command found -> '$command_response'"
    printf "Run this command? [Y/n] "
    stty raw
    answer=$(dd bs=1 count=1 2>/dev/null)
    stty -raw

    case "$answer" in
    [Nn])
        echo "\nCommand not executed"
        ;;
    *)
        echo
        echo "$command_response" >cmd.tmp
        sh cmd.tmp
        rm cmd.tmp
        ;;
    esac
else
    echo "$command_response"
fi
