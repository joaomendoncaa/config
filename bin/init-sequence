#!/usr/bin/env bash

launch_webapp() {
	local url="$1"
	local ws="$2"

	browser=$(xdg-settings get default-web-browser)

	case $browser in
	google-chrome* | brave-browser* | microsoft-edge* | opera* | vivaldi*) ;;
	*) browser="chromium.desktop" ;;
	esac

	browser_exec=$(sed -n 's/^Exec=\([^ ]*\).*/\1/p' {~/.local,~/.nix-profile,/usr}/share/applications/$browser 2>/dev/null | head -1)

	old_addrs=$(hyprctl clients -j | jq -r '.[].address' | sort)

	setsid uwsm app -- "$browser_exec" --app="$url" "${@:3}" &

	for i in {1..50}; do
		sleep 0.1
		new_addrs=$(hyprctl clients -j | jq -r '.[].address' | sort)
		new=$(comm -23 <(printf "%s\n" "$new_addrs") <(printf "%s\n" "$old_addrs"))
		if [ -n "$new" ]; then
			new_addr=$(echo "$new" | head -1)
			hyprctl dispatch movetoworkspacesilent "$ws,address:$new_addr"
			break
		fi
	done
}

hyprctl dispatch exec [workspace 1 silent] uwsm app -- alacritty

hyprctl dispatch exec [workspace 2 silent] zen-browser

launch_webapp "https://web.whatsapp.com" 3
launch_webapp "https://mail.proton.me" 3
launch_webapp "https://messages.google.com/web/conversations" 3
hyprctl dispatch exec [workspace 3 silent] Telegram

launch_webapp "http://x.com" 4

hyprctl dispatch exec [workspace 5 silent] steam
